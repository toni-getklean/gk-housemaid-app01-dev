name: Build and Deploy Housemaid Design 01

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - master

jobs:
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    timeout-minutes: 30

    concurrency:
      group: fly-deployment
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4

      - name: Install Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Ensure Fly.io app exists
        run: |
          if ! flyctl apps show gk-housemaid-app01 > /dev/null 2>&1; then
            echo "App 'gk-housemaid-app01' does not exist. Creating it..."
            flyctl apps create gk-housemaid-app01 --org get-klean-philippines
          else
            echo "App 'gk-housemaid-app01' already exists."
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Sync secrets to Fly.io
        run: |
          flyctl secrets set \
            FLY_API_TOKEN="$FLY_API_TOKEN" \
            CYN_API_ID="$CYN_API_ID" \
            CYN_API_PASSWORD="$CYN_API_PASSWORD" \
            CYN_API_URL="$CYN_API_URL" \
            CYN_SENDER_ID="$CYN_SENDER_ID" \
            DATABASE_URL="$DATABASE_URL" \
            FACEBOOK_APP_SECRET="$FACEBOOK_APP_SECRET" \
            FACEBOOK_REDIRECT_URI="$FACEBOOK_REDIRECT_URI" \
            JWT_SECRET="$JWT_SECRET" \
            NEXT_PUBLIC_FACEBOOK_APP_ID="$NEXT_PUBLIC_FACEBOOK_APP_ID" \
            UPLOADTHING_TOKEN="$UPLOADTHING_TOKEN" \
            -a gk-housemaid-app01
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          CYN_API_ID: ${{ secrets.CYN_API_ID }}
          CYN_API_PASSWORD: ${{ secrets.CYN_API_PASSWORD }}
          CYN_API_URL: ${{ secrets.CYN_API_URL }}
          CYN_SENDER_ID: ${{ secrets.CYN_SENDER_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          FACEBOOK_APP_SECRET: ${{ secrets.FACEBOOK_APP_SECRET }}
          FACEBOOK_REDIRECT_URI: ${{ secrets.FACEBOOK_REDIRECT_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NEXT_PUBLIC_FACEBOOK_APP_ID: ${{ secrets.NEXT_PUBLIC_FACEBOOK_APP_ID }}
          UPLOADTHING_TOKEN: ${{ secrets.UPLOADTHING_TOKEN }}

      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only
