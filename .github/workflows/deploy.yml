name: Build and Deploy Housemaid Design 01

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - master

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20.9"
          cache: "npm"

  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    needs: build
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

    concurrency:
      group: fly-deployment
      cancel-in-progress: false

    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20.9"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Cache Next.js build
        uses: actions/cache@v3
        with:
          path: .next/cache
          key: nextjs-build-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            nextjs-build-${{ runner.os }}-

      - name: Install Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Ensure Fly.io app exists
        run: |
          flyctl apps show gk-housemaid-app01 >/dev/null 2>&1 || \
          flyctl apps create gk-housemaid-app01 --org get-klean-philippines
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Sync secrets to Fly.io
        run: |
          flyctl secrets set \
            CYN_API_ID="$CYN_API_ID" \
            CYN_API_PASSWORD="$CYN_API_PASSWORD" \
            CYN_API_URL="$CYN_API_URL" \
            CYN_SENDER_ID="$CYN_SENDER_ID" \
            DATABASE_URL="$DATABASE_URL" \
            FACEBOOK_APP_SECRET="$FACEBOOK_APP_SECRET" \
            FACEBOOK_REDIRECT_URI="$FACEBOOK_REDIRECT_URI" \
            JWT_SECRET="$JWT_SECRET" \
            NEXT_PUBLIC_FACEBOOK_APP_ID="$NEXT_PUBLIC_FACEBOOK_APP_ID" \
            UPLOADTHING_TOKEN="$UPLOADTHING_TOKEN" \
            -a gk-housemaid-app01
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          CYN_API_ID: ${{ secrets.CYN_API_ID }}
          CYN_API_PASSWORD: ${{ secrets.CYN_API_PASSWORD }}
          CYN_API_URL: ${{ secrets.CYN_API_URL }}
          CYN_SENDER_ID: ${{ secrets.CYN_SENDER_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          FACEBOOK_APP_SECRET: ${{ secrets.FACEBOOK_APP_SECRET }}
          FACEBOOK_REDIRECT_URI: ${{ secrets.FACEBOOK_REDIRECT_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NEXT_PUBLIC_FACEBOOK_APP_ID: ${{ secrets.NEXT_PUBLIC_FACEBOOK_APP_ID }}
          UPLOADTHING_TOKEN: ${{ secrets.UPLOADTHING_TOKEN }}

      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only
